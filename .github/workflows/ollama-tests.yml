name: CI

on:
  push:
    tags:
      - "v*.*.*"
    branches:
      - main
  pull_request:

env:
  CARGO_TERM_COLOR: always

jobs:
  ollama-tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}-is

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Install Cargo Make
        run: cargo install --locked --force cargo-make

      - name: Install Golem CLI
        run: cargo install --locked --force golem-cli@1.2.2-dev.11

      - name: Install WAC CLI
        run: cargo install --locked --force wac-cli

      - name: Build Ollama components
        run: cargo make build-test-components

      - name: Build Golem app with ollama-debug profile
        working-directory: test
        run: |
          golem-cli app clean
          golem-cli app build -b ollama-debug

      - name: Run all Ollama guest tests
        working-directory: test
        run: |
          for TEST_FN in test1 test2 test3 test4 test5 test6; do
            echo ""
            echo "üöÄ Running $TEST_FN..."
            golem-cli test --component test:llm --profile ollama-debug --function $TEST_FN \
              || { echo "‚ùå $TEST_FN FAILED"; exit 1; }
            echo "‚úÖ $TEST_FN PASSED"
          done

      - name: All tests passed
        run: echo "üéâ All Ollama tests completed successfully!"
